# ğŸš€ å¿«é€Ÿè¨­ç½®æŒ‡å—

## âœ… ç•¶å‰ç‹€æ…‹

- [x] EMQX Docker å®¹å™¨å·²å•Ÿå‹•
- [x] ESP32 ç¨‹å¼ç¢¼å·²æ›´æ–°ï¼ˆMQTT æ•´åˆï¼‰
- [x] MQTT Broker IP å·²é…ç½®ï¼š192.168.3.1
- [x] æ¸¬è©¦è…³æœ¬å·²å‰µå»º

## ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ

### 1ï¸âƒ£ ç·¨è­¯ä¸¦ä¸Šå‚³åˆ° ESP32

```bash
cd /Users/funtuanhomemac/esp32-project/esp32-ir-arduino
pio run -t upload
```

### 2ï¸âƒ£ ç›£è¦– ESP32 è¼¸å‡º

```bash
pio device monitor
```

**é æœŸè¼¸å‡ºï¼š**
```
âœ“ WiFi å·²é€£æ¥!
IP: 192.168.x.x
âœ“ MQTT å·²é€£æ¥!
âœ“ å·²è¨‚é–±æ§åˆ¶ä¸»é¡Œ
âœ“ Web Server å·²å•Ÿå‹•
ç³»çµ±å°±ç·’!
```

### 3ï¸âƒ£ å®‰è£ mosquitto å®¢æˆ¶ç«¯ï¼ˆå¦‚æœªå®‰è£ï¼‰

```bash
brew install mosquitto
```

### 4ï¸âƒ£ æ¸¬è©¦ MQTT é€šè¨Š

**æ–¹æ³• Aï¼šä½¿ç”¨äº’å‹•å¼æ¸¬è©¦è…³æœ¬**
```bash
./mqtt-test.sh
```

**æ–¹æ³• Bï¼šæ‰‹å‹•æ¸¬è©¦**
```bash
# è¨‚é–±ç‹€æ…‹ï¼ˆé–‹ä¸€å€‹çµ‚ç«¯ï¼‰
mosquitto_sub -h localhost -t "homebridge/ac/#" -v

# ç™¼é€æŒ‡ä»¤ï¼ˆå¦é–‹çµ‚ç«¯ï¼‰
mosquitto_pub -h localhost -t "homebridge/ac/command" -m '{"command":"ON"}'
```

### 5ï¸âƒ£ è¨ªå• EMQX Dashboard

é–‹å•Ÿç€è¦½å™¨ï¼šhttp://localhost:18083
- å¸³è™Ÿï¼š`admin`
- å¯†ç¢¼ï¼š`public`

**å¯ä»¥æŸ¥çœ‹ï¼š**
- é€£æ¥çš„å®¢æˆ¶ç«¯ï¼ˆæ‡‰è©²çœ‹åˆ° ESP32_AC_Controllerï¼‰
- è¨‚é–±çš„ä¸»é¡Œ
- å³æ™‚è¨Šæ¯æµé‡

### 6ï¸âƒ£ é…ç½® Homebridge

**å®‰è£å¤–æ›ï¼š**
```bash
npm install -g homebridge-mqttthing
```

**ç·¨è¼¯é…ç½®ï¼š**
```bash
nano ~/.homebridge/config.json
```

å°‡ `homebridge-config.json` çš„å…§å®¹åˆä½µåˆ°æ‚¨çš„é…ç½®ä¸­ã€‚

**é‡å•Ÿ Homebridgeï¼š**
```bash
# macOS service
brew services restart homebridge

# æˆ–æ‰‹å‹•é‹è¡Œ
homebridge
```

### 7ï¸âƒ£ åœ¨ HomeKit ä¸­æ·»åŠ é…ä»¶

1. é–‹å•Ÿã€Œå®¶åº­ã€App
2. é»æ“Šå³ä¸Šè§’ã€Œ+ã€â†’ã€ŒåŠ å…¥é…ä»¶ã€
3. é¸æ“‡ã€Œæ›´å¤šé¸é …ã€
4. æ‰¾åˆ°ã€Œå†·æ°£ã€é…ä»¶
5. è¼¸å…¥ Homebridge çš„é…å°ç¢¼

## ğŸ§ª æ¸¬è©¦æµç¨‹

### æ¸¬è©¦ 1ï¼šMQTT é€šè¨Š
```bash
# è¨‚é–±
mosquitto_sub -h localhost -t "homebridge/ac/state"

# ç™¼é€é–‹æ©Ÿï¼ˆå¦é–‹çµ‚ç«¯ï¼‰
mosquitto_pub -h localhost -t "homebridge/ac/command" -m '{"command":"ON"}'
```

**é æœŸçµæœï¼š**
- ESP32 åºåˆ—ç›£è¦–å™¨é¡¯ç¤ºæ”¶åˆ°æŒ‡ä»¤
- ç´…å¤–ç·šç™¼é€å™¨ç™¼é€è¨Šè™Ÿ
- è¨‚é–±çµ‚ç«¯æ”¶åˆ°ç‹€æ…‹æ›´æ–°

### æ¸¬è©¦ 2ï¼šæº«åº¦æ§åˆ¶
```bash
mosquitto_pub -h localhost -t "homebridge/ac/temperature/set" -m '{"temperature":24}'
```

### æ¸¬è©¦ 3ï¼šæ¨¡å¼åˆ‡æ›
```bash
mosquitto_pub -h localhost -t "homebridge/ac/mode/set" -m '{"mode":"cool"}'
```

### æ¸¬è©¦ 4ï¼šWeb æ§åˆ¶
ç€è¦½å™¨è¨ªå• ESP32 çš„ IPï¼ˆåœ¨åºåˆ—ç›£è¦–å™¨ä¸­é¡¯ç¤ºï¼‰

### æ¸¬è©¦ 5ï¼šHomebridge æ§åˆ¶
åœ¨ã€Œå®¶åº­ã€App ä¸­æ§åˆ¶å†·æ°£

## âš ï¸ å¸¸è¦‹å•é¡Œ

### ESP32 ç„¡æ³•é€£æ¥ MQTT

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. ç¢ºèª EMQX æ­£åœ¨é‹è¡Œï¼š
   ```bash
   docker ps | grep emqx
   ```

2. æª¢æŸ¥ Mac IP æ˜¯å¦æ­£ç¢ºï¼š
   ```bash
   ifconfig | grep "inet " | grep -v 127.0.0.1
   ```

3. æ¸¬è©¦ç¶²è·¯é€£é€šæ€§ï¼ˆå¾ ESP32 åˆ° Macï¼‰

4. æª¢æŸ¥é˜²ç«ç‰†è¨­å®šï¼ˆå…è¨± 1883 ç«¯å£ï¼‰

### MQTT è¨Šæ¯æœªæ”¶åˆ°

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. åœ¨ EMQX Dashboard æŸ¥çœ‹å®¢æˆ¶ç«¯é€£æ¥ç‹€æ…‹
2. æŸ¥çœ‹è¨‚é–±ä¸»é¡Œæ˜¯å¦æ­£ç¢º
3. ä½¿ç”¨ mosquitto_sub é©—è­‰è¨Šæ¯æ˜¯å¦ç™¼å¸ƒ

### Homebridge ç„¡æ³•æ§åˆ¶

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. æª¢æŸ¥ homebridge-mqttthing æ˜¯å¦å®‰è£æˆåŠŸ
2. é©—è­‰ config.json æ ¼å¼æ­£ç¢º
3. æŸ¥çœ‹ Homebridge æ—¥èªŒï¼š
   ```bash
   tail -f ~/.homebridge/homebridge.log
   ```

## ğŸ“Š ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HomeKit App   â”‚
â”‚  (iPhone/iPad)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Homebridge    â”‚
â”‚  MQTT Thing     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EMQX Broker    â”‚
â”‚  (Docker)       â”‚
â”‚  Port: 1883     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ESP32       â”‚
â”‚  MQTT Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IR Transmitter â”‚
â”‚    (GPIO 4)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Panasonic AC    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ MQTT ä¸»é¡Œçµæ§‹

```
homebridge/ac/
â”œâ”€â”€ command          (è¨‚é–±) é–‹é—œæ§åˆ¶
â”œâ”€â”€ state            (ç™¼å¸ƒ) å®Œæ•´ç‹€æ…‹
â”œâ”€â”€ temperature/
â”‚   â”œâ”€â”€ set          (è¨‚é–±) è¨­å®šç›®æ¨™æº«åº¦
â”‚   â””â”€â”€ state        (ç™¼å¸ƒ) ç•¶å‰æº«åº¦
â””â”€â”€ mode/
    â”œâ”€â”€ set          (è¨‚é–±) è¨­å®šé‹è½‰æ¨¡å¼
    â””â”€â”€ state        (ç™¼å¸ƒ) ç•¶å‰æ¨¡å¼
```

## ğŸ” é€²éšé…ç½®ï¼ˆå¯é¸ï¼‰

### å•Ÿç”¨ MQTT èªè­‰

1. åœ¨ EMQX Dashboard è¨­å®šç”¨æˆ¶å/å¯†ç¢¼
2. æ›´æ–° ESP32 ç¨‹å¼ç¢¼ï¼š
   ```cpp
   #define MQTT_USER "esp32"
   #define MQTT_PASSWORD "your_password"
   ```
3. æ›´æ–° Homebridge config.json

### ä½¿ç”¨ SSL/TLS

- ç«¯å£æ”¹ç‚º 8883
- é…ç½®è­‰æ›¸

## ğŸ“š åƒè€ƒè³‡æº

- [EMQX æ–‡æª”](https://www.emqx.io/docs)
- [homebridge-mqttthing](https://github.com/arachnetech/homebridge-mqttthing)
- [IRremoteESP8266](https://github.com/crankyoldgit/IRremoteESP8266)

## ğŸ†˜ ç²å–å¹«åŠ©

å¦‚é‡åˆ°å•é¡Œï¼š
1. æŸ¥çœ‹ ESP32 åºåˆ—ç›£è¦–å™¨è¼¸å‡º
2. æª¢æŸ¥ EMQX Dashboard çš„é€£æ¥ç‹€æ…‹
3. æŸ¥çœ‹ Homebridge æ—¥èªŒ
4. ä½¿ç”¨ mosquitto_sub/pub æ¸¬è©¦ MQTT é€šè¨Š

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰**
